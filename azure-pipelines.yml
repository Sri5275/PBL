trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: Pipeline
- name: GITHUB_API_URL
  value: 'https://api.github.com/user'

steps:
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      # Retrieve variables
      $pat = "$(GitHubPAT)"

      # Set the headers for the API request
      $headers = @{
        'Authorization' = "Bearer $pat"
      }

      # Make the GET request to the GitHub API to retrieve user information
      $response = Invoke-RestMethod -Uri $(GITHUB_API_URL) -Method Get -Headers $headers

      # Extract username and email from the GitHub response
      $username = $response.login
      $email = $null

      # If the email is available, retrieve it using a specific GitHub API endpoint
      if ($response.email) {
        $email = Invoke-RestMethod -Uri 'https://api.github.com/user/emails' -Method Get -Headers $headers |
                 Where-Object { $_.primary -eq $true } |
                 Select-Object -ExpandProperty email
      }

      # Print the retrieved details
      Write-Host "Retrieved GitHub Username: $username"
      if ($email) {
        Write-Host "Retrieved GitHub Email: $email"
      } else {
        Write-Host "GitHub Email is not available publicly."
      }
  env:
    GitHubPAT: $(GitHubPAT)
